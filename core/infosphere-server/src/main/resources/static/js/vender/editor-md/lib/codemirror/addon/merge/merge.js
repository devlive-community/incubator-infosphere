(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("diff_match_patch"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","diff_match_patch"],a)}else{a(CodeMirror,diff_match_patch)}}})(function(s,O){var j=s.Pos;var D="http://www.w3.org/2000/svg";function g(S,T){this.mv=S;this.type=T;this.classes=T=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}g.prototype={constructor:g,init:function(U,T,S){this.edit=this.mv.edit;this.orig=s(U,k({value:T,readOnly:!this.mv.options.allowEditingOriginals},k(S)));this.diff=b(y(T),y(S.value));this.chunks=m(this.diff);this.diffOutOfDate=this.dealigned=false;this.showDifferences=S.showDifferences!==false;this.forceUpdate=M(this);p(this,true,false);d(this)},setShowDifferences:function(S){S=S!==false;if(S!=this.showDifferences){this.showDifferences=S;this.forceUpdate("full")}}};function E(S){if(S.diffOutOfDate){S.diff=b(S.orig.getValue(),S.edit.getValue());S.chunks=m(S.diff);S.diffOutOfDate=false;s.signal(S.edit,"updateDiff",S.diff)}}var R=false;function M(T){var Z={from:0,to:0,marked:[]};var X={from:0,to:0,marked:[]};var S,aa=false;function U(ab){R=true;aa=false;if(ab=="full"){if(T.svg){C(T.svg)}if(T.copyButtons){C(T.copyButtons)}P(T.edit,Z.marked,T.classes);P(T.orig,X.marked,T.classes);Z.from=Z.to=X.from=X.to=0}E(T);if(T.showDifferences){o(T.edit,T.diff,Z,DIFF_INSERT,T.classes);o(T.orig,T.diff,X,DIFF_DELETE,T.classes)}l(T);if(T.mv.options.connect=="align"){e(T)}R=false}function V(ab){if(R){return}T.dealigned=true;Y(ab)}function Y(ab){if(R||aa){return}clearTimeout(S);if(ab===true){aa=true}S=setTimeout(U,ab===true?20:250)}function W(ab,ac){if(!T.diffOutOfDate){T.diffOutOfDate=true;Z.from=Z.to=X.from=X.to=0}V(ac.text.length-1!=ac.to.line-ac.from.line)}T.edit.on("change",W);T.orig.on("change",W);T.edit.on("markerAdded",V);T.edit.on("markerCleared",V);T.orig.on("markerAdded",V);T.orig.on("markerCleared",V);T.edit.on("viewportChange",function(){Y(false)});T.orig.on("viewportChange",function(){Y(false)});U();return U}function d(S){S.edit.on("scroll",function(){v(S,DIFF_INSERT)&&l(S)});S.orig.on("scroll",function(){v(S,DIFF_DELETE)&&l(S)})}function v(ae,W){if(ae.diffOutOfDate){return false}if(!ae.lockScroll){return true}var X,Z,U=+new Date;if(W==DIFF_INSERT){X=ae.edit;Z=ae.orig}else{X=ae.orig;Z=ae.edit}if(X.state.scrollSetBy==ae&&(X.state.scrollSetAt||0)+50>U){return false}var S=X.getScrollInfo();if(ae.mv.options.connect=="align"){V=S.top}else{var T=0.5*S.clientHeight,ac=S.top+T;var ai=X.lineAtHeight(ac,"local");var ag=Q(ae.chunks,ai,W==DIFF_INSERT);var aj=K(X,W==DIFF_INSERT?ag.edit:ag.orig);var ab=K(Z,W==DIFF_INSERT?ag.orig:ag.edit);var aa=(ac-aj.top)/(aj.bot-aj.top);var V=(ab.top-T)+aa*(ab.bot-ab.top);var Y,ad;if(V>S.top&&(ad=S.top/T)<1){V=V*ad+S.top*(1-ad)}else{if((Y=S.height-S.clientHeight-S.top)<T){var ah=Z.getScrollInfo();var af=ah.height-ah.clientHeight-V;if(af>Y&&(ad=Y/T)<1){V=V*ad+(ah.height-ah.clientHeight-Y)*(1-ad)}}}}Z.scrollTo(S.left,V);Z.state.scrollSetAt=U;Z.state.scrollSetBy=ae;return true}function K(S,T){var U=T.after;if(U==null){U=S.lastLine()+1}return{top:S.heightAtLine(T.before||0,"local"),bot:S.heightAtLine(U,"local")}}function p(S,U,T){S.lockScroll=U;if(U&&T!=false){v(S,DIFF_INSERT)&&l(S)}S.lockButton.innerHTML=U?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function P(V,S,U){for(var T=0;T<S.length;++T){var W=S[T];if(W instanceof s.TextMarker){W.clear()}else{if(W.parent){V.removeLineClass(W,"background",U.chunk);V.removeLineClass(W,"background",U.start);V.removeLineClass(W,"background",U.end)}}}S.length=0}function o(V,X,W,U,T){var S=V.getViewport();V.operation(function(){if(W.from==W.to||S.from-W.to>20||W.from-S.to>20){P(V,W.marked,T);c(V,X,U,W.marked,S.from,S.to,T);W.from=S.from;W.to=S.to}else{if(S.from<W.from){c(V,X,U,W.marked,S.from,W.from,T);W.from=S.from}if(S.to>W.to){c(V,X,U,W.marked,W.to,S.to,T);W.to=S.to}}})}function c(Z,ac,Y,ai,ah,U,ak){var aa=j(0,0);var ae=j(ah,0),ad=Z.clipPos(j(U-1));var S=Y==DIFF_DELETE?ak.del:ak.insert;function ab(au,ap){var at=Math.max(ah,au),aq=Math.min(U,ap);for(var ar=at;ar<aq;++ar){var ao=Z.addLineClass(ar,"background",ak.chunk);if(ar==au){Z.addLineClass(ao,"background",ak.start)}if(ar==ap-1){Z.addLineClass(ao,"background",ak.end)}ai.push(ao)}if(au==ap&&at==ap&&aq==ap){if(at){ai.push(Z.addLineClass(at-1,"background",ak.end))}else{ai.push(Z.addLineClass(at,"background",ak.start))}}}var an=0;for(var aj=0;aj<ac.length;++aj){var ag=ac[aj],T=ag[0],af=ag[1];if(T==DIFF_EQUAL){var X=aa.line+(F(ac,aj)?0:1);A(aa,af);var W=aa.line+(I(ac,aj)?1:0);if(W>X){if(aj){ab(an,X)}an=W}}else{if(T==Y){var V=A(aa,af,true);var am=G(ae,aa),al=h(ad,V);if(!L(am,al)){ai.push(Z.markText(am,al,{className:S}))}aa=V}}}if(an<=aa.line){ab(an,aa.line+1)}}function l(W){if(!W.showDifferences){return}if(W.svg){C(W.svg);var T=W.gap.offsetWidth;f(W.svg,"width",T,"height",W.gap.offsetHeight)}if(W.copyButtons){C(W.copyButtons)}var Z=W.edit.getViewport(),U=W.orig.getViewport();var S=W.edit.getScrollInfo().top,Y=W.orig.getScrollInfo().top;for(var V=0;V<W.chunks.length;V++){var X=W.chunks[V];if(X.editFrom<=Z.to&&X.editTo>=Z.from&&X.origFrom<=U.to&&X.origTo>=U.from){a(W,X,Y,S,T)}}}function w(X,W){var V=0,U=0;for(var T=0;T<W.length;T++){var S=W[T];if(S.editTo>X&&S.editFrom<=X){return null}if(S.editFrom>X){break}V=S.editTo;U=S.origTo}return U+(X-V)}function i(X,S){var W=[];for(var V=0;V<X.chunks.length;V++){var U=X.chunks[V];W.push([U.origTo,U.editTo,S?w(U.editTo,S.chunks):null])}if(S){for(var V=0;V<S.chunks.length;V++){var U=S.chunks[V];for(var T=0;T<W.length;T++){var Y=W[T];if(Y[1]==U.editTo){T=-1;break}else{if(Y[1]>U.editTo){break}}}if(T>-1){W.splice(T-1,0,[w(U.editTo,X.chunks),U.editTo,U.origTo])}}}return W}function e(S,T){if(!S.dealigned&&!T){return}if(!S.orig.curOp){return S.orig.operation(function(){e(S,T)})}S.dealigned=false;var W=S.mv.left==S?S.mv.right:S.mv.left;if(W){E(W);W.dealigned=false}var V=i(S,W);var aa=S.mv.aligners;for(var U=0;U<aa.length;U++){aa[U].clear()}aa.length=0;var Z=[S.orig,S.edit],Y=[];if(W){Z.push(W.orig)}for(var U=0;U<Z.length;U++){Y.push(Z[U].getScrollInfo().top)}for(var X=0;X<V.length;X++){H(Z,V[X],aa)}for(var U=0;U<Z.length;U++){Z[U].scrollTo(null,Y[U])}}function H(S,T,W){var V=0,Z=[];for(var U=0;U<S.length;U++){if(T[U]!=null){var Y=S[U].heightAtLine(T[U],"local");Z[U]=Y;V=Math.max(V,Y)}}for(var U=0;U<S.length;U++){if(T[U]!=null){var X=V-Z[U];if(X>1){W.push(z(S[U],T[U],X))}}}}function z(T,U,W){var S=true;if(U>T.lastLine()){U--;S=false}var V=document.createElement("div");V.className="CodeMirror-merge-spacer";V.style.height=W+"px";V.style.minWidth="1px";return T.addLineWidget(U,V,{height:W,above:S})}function a(aa,Z,ae,T,Y){var V=aa.type=="left";var ac=aa.orig.heightAtLine(Z.origFrom,"local")-ae;if(aa.svg){var S=ac;var X=aa.edit.heightAtLine(Z.editFrom,"local")-T;if(V){var aj=S;S=X;X=aj}var W=aa.orig.heightAtLine(Z.origTo,"local")-ae;var af=aa.edit.heightAtLine(Z.editTo,"local")-T;if(V){var aj=W;W=af;af=aj}var ad=" C "+Y/2+" "+X+" "+Y/2+" "+S+" "+(Y+2)+" "+S;var ab=" C "+Y/2+" "+W+" "+Y/2+" "+af+" -1 "+af;f(aa.svg.appendChild(document.createElementNS(D,"path")),"d","M -1 "+X+ad+" L "+(Y+2)+" "+W+ab+" z","class",aa.classes.connect)}if(aa.copyButtons){var ah=aa.copyButtons.appendChild(J("div",aa.type=="left"?"\u21dd":"\u21dc","CodeMirror-merge-copy"));var ag=aa.mv.options.allowEditingOriginals;ah.title=ag?"Push to left":"Revert chunk";ah.chunk=Z;ah.style.top=ac+"px";if(ag){var ai=aa.orig.heightAtLine(Z.editFrom,"local")-T;var U=aa.copyButtons.appendChild(J("div",aa.type=="right"?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse"));U.title="Push to right";U.chunk={editFrom:Z.origFrom,editTo:Z.origTo,origFrom:Z.editFrom,origTo:Z.editTo};U.style.top=ai+"px";aa.type=="right"?U.style.left="2px":U.style.right="2px"}}}function n(T,V,U,S){if(T.diffOutOfDate){return}V.replaceRange(U.getRange(j(S.origFrom,0),j(S.origTo,0)),j(S.editFrom,0),j(S.editTo,0))}var r=s.MergeView=function(X,ah){if(!(this instanceof r)){return new r(X,ah)}this.options=ah;var aa=ah.origLeft,Y=ah.origRight==null?ah.orig:ah.origRight;var ad=aa!=null,ai=Y!=null;var ab=1+(ad?1:0)+(ai?1:0);var U=[],W=this.left=null,ae=this.right=null;var ag=this;if(ad){W=this.left=new g(this,"left");var T=J("div",null,"CodeMirror-merge-pane");U.push(T);U.push(x(W))}var Z=J("div",null,"CodeMirror-merge-pane");U.push(Z);if(ai){ae=this.right=new g(this,"right");U.push(x(ae));var ac=J("div",null,"CodeMirror-merge-pane");U.push(ac)}(ai?ac:Z).className+=" CodeMirror-merge-pane-rightmost";U.push(J("div",null,null,"height: 0; clear: both;"));var V=this.wrap=X.appendChild(J("div",U,"CodeMirror-merge CodeMirror-merge-"+ab+"pane"));this.edit=s(Z,k(ah));if(W){W.init(T,aa,ah)}if(ae){ae.init(ac,Y,ah)}if(ah.collapseIdentical){R=true;this.editor().operation(function(){N(ag,ah.collapseIdentical)});R=false}if(ah.connect=="align"){this.aligners=[];e(this.left||this.right,true)}var S=function(){if(W){l(W)}if(ae){l(ae)}};s.on(window,"resize",S);var af=setInterval(function(){for(var aj=V.parentNode;aj&&aj!=document.body;aj=aj.parentNode){}if(!aj){clearInterval(af);s.off(window,"resize",S)}},5000)};function x(V){var U=V.lockButton=J("div",null,"CodeMirror-merge-scrolllock");U.title="Toggle locked scrolling";var W=J("div",[U],"CodeMirror-merge-scrolllock-wrap");s.on(U,"click",function(){p(V,!V.lockScroll)});var T=[W];if(V.mv.options.revertButtons!==false){V.copyButtons=J("div",null,"CodeMirror-merge-copybuttons-"+V.type);s.on(V.copyButtons,"click",function(Y){var X=Y.target||Y.srcElement;if(!X.chunk){return}if(X.className=="CodeMirror-merge-copy-reverse"){n(V,V.orig,V.edit,X.chunk);return}n(V,V.edit,V.orig,X.chunk)});T.unshift(V.copyButtons)}if(V.mv.options.connect!="align"){var S=document.createElementNS&&document.createElementNS(D,"svg");if(S&&!S.createSVGRect){S=null}V.svg=S;if(S){T.push(S)}}return V.gap=J("div",T,"CodeMirror-merge-gap")}r.prototype={constuctor:r,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(S){if(this.right){this.right.setShowDifferences(S)}if(this.left){this.left.setShowDifferences(S)}},rightChunks:function(){if(this.right){E(this.right);return this.right.chunks}},leftChunks:function(){if(this.left){E(this.left);return this.left.chunks}}};function y(S){if(typeof S=="string"){return S}else{return S.getValue()}}var B=new O();function b(T,S){var W=B.diff_main(T,S);B.diff_cleanupSemantic(W);for(var V=0;V<W.length;++V){var U=W[V];if(!U[1]){W.splice(V--,1)}else{if(V&&W[V-1][0]==U[0]){W.splice(V--,1);W[V][1]+=U[1]}}}return W}function m(af){var X=[];var ac=0,ab=0;var ag=j(0,0),ae=j(0,0);for(var U=0;U<af.length;++U){var T=af[U],ad=T[0];if(ad==DIFF_EQUAL){var S=F(af,U)?0:1;var W=ag.line+S,V=ae.line+S;A(ag,T[1],null,ae);var Y=I(af,U)?1:0;var aa=ag.line+Y,Z=ae.line+Y;if(aa>W){if(U){X.push({origFrom:ab,origTo:V,editFrom:ac,editTo:W})}ac=aa;ab=Z}}else{A(ad==DIFF_INSERT?ag:ae,T[1])}}if(ac<=ag.line||ab<=ae.line){X.push({origFrom:ab,origTo:ae.line+1,editFrom:ac,editTo:ag.line+1})}return X}function I(U,S){if(S==U.length-1){return true}var T=U[S+1][1];if(T.length==1||T.charCodeAt(0)!=10){return false}if(S==U.length-2){return true}T=U[S+2][1];return T.length>1&&T.charCodeAt(0)==10}function F(U,S){if(S==0){return true}var T=U[S-1][1];if(T.charCodeAt(T.length-1)!=10){return false}if(S==1){return true}T=U[S-2][1];return T.charCodeAt(T.length-1)==10}function Q(W,S,Y){var aa,ac,U,X;for(var T=0;T<W.length;T++){var Z=W[T];var ab=Y?Z.editFrom:Z.origFrom;var V=Y?Z.editTo:Z.origTo;if(ac==null){if(ab>S){ac=Z.editFrom;X=Z.origFrom}else{if(V>S){ac=Z.editTo;X=Z.origTo}}}if(V<=S){aa=Z.editTo;U=Z.origTo}else{if(ab<=S){aa=Z.editFrom;U=Z.origFrom}}}return{edit:{before:aa,after:ac},orig:{before:U,after:X}}}function u(T,X,W){T.addLineClass(X,"wrap","CodeMirror-merge-collapsed-line");var U=document.createElement("span");U.className="CodeMirror-merge-collapsed-widget";U.title="Identical text collapsed. Click to expand.";var V=T.markText(j(X,0),j(W-1),{inclusiveLeft:true,inclusiveRight:true,replacedWith:U,clearOnEnter:true});function S(){V.clear();T.removeLineClass(X,"wrap","CodeMirror-merge-collapsed-line")}U.addEventListener("click",S);return{mark:V,clear:S}}function q(U,X){var W=[];function S(){for(var Z=0;Z<W.length;Z++){W[Z].clear()}}for(var T=0;T<X.length;T++){var V=X[T];var Y=u(V.cm,V.line,V.line+U);W.push(Y);Y.mark.on("clear",S)}return W[0].mark}function t(W,X,Y,S){for(var V=0;V<W.chunks.length;V++){var U=W.chunks[V];for(var T=U.editFrom-X;T<U.editTo+X;T++){var Z=T+Y;if(Z>=0&&Z<S.length){S[Z]=false}}}}function N(ab,V){if(typeof V!="number"){V=2}var X=[],aa=ab.editor(),S=aa.firstLine();for(var T=S,Y=aa.lastLine();T<=Y;T++){X.push(true)}if(ab.left){t(ab.left,V,S,X)}if(ab.right){t(ab.right,V,S,X)}for(var W=0;W<X.length;W++){if(X[W]){var ad=W+S;for(var ac=1;W<X.length-1&&X[W+1];W++,ac++){}if(ac>V){var Z=[{line:ad,cm:aa}];if(ab.left){Z.push({line:w(ad,ab.left.chunks),cm:ab.left.orig})}if(ab.right){Z.push({line:w(ad,ab.right.chunks),cm:ab.right.orig})}var U=q(ac,Z);if(ab.options.onCollapse){ab.options.onCollapse(ab,ad,ac,U)}}}}}function J(S,W,V,U){var X=document.createElement(S);if(V){X.className=V}if(U){X.style.cssText=U}if(typeof W=="string"){X.appendChild(document.createTextNode(W))}else{if(W){for(var T=0;T<W.length;++T){X.appendChild(W[T])}}}return X}function C(T){for(var S=T.childNodes.length;S>0;--S){T.removeChild(T.firstChild)}}function f(S){for(var T=1;T<arguments.length;T+=2){S.setAttribute(arguments[T],arguments[T+1])}}function k(T,S){if(!S){S={}}for(var U in T){if(T.hasOwnProperty(U)){S[U]=T[U]}}return S}function A(Y,W,X,T){var V=X?j(Y.line,Y.ch):Y,S=0;for(;;){var U=W.indexOf("\n",S);if(U==-1){break}++V.line;if(T){++T.line}S=U+1}V.ch=(S?0:V.ch)+(W.length-S);if(T){T.ch=(S?0:T.ch)+(W.length-S)}return V}function h(T,S){return(T.line-S.line||T.ch-S.ch)<0?T:S}function G(T,S){return(T.line-S.line||T.ch-S.ch)>0?T:S}function L(T,S){return T.line==S.line&&T.ch==S.ch}});